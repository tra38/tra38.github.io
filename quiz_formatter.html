<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quiz & Answer Key Generator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
    h1, h2 { text-align: center; }
    #inputArea { width: 100%; min-height: 250px; border: 1px solid #ccc; padding: 10px; overflow: auto; margin-bottom: 20px; }
    .section { border: 1px solid #888; padding: 15px; margin-bottom: 30px; }
    .question-block { margin-bottom: 20px; }
    .question-block p { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>Quiz & Answer Key Generator</h1>
  <p>
    Paste your formatted questions below. (Any HTML formatting – such as <strong>bold text</strong> – will be preserved.)
  </p>
  <p>Generated by o3-mini-high and o3.</p>
  <div id="inputArea" contenteditable="true">
    <!-- Example questions -->
    <p>Question 1:</p>
    <p>Which of the following best describes pharmacogenomics?</p>
    <p>A) The study of the physical and chemical properties of drugs<br>
      B) The study of hereditary factors on individual responses to medications<br>
      C) The study of genetic factors influencing drug effectiveness, toxicity, and metabolism<br>
      D) The study of drug interactions and their effects on the body</p>
    <p>Answer: C) The study of genetic factors influencing drug effectiveness, toxicity, and metabolism</p>
    <p>Explanation: Pharmacogenomics focuses on how genetic variations affect an individual's response to medications, influencing drug metabolism, effectiveness, and toxicity. This differs from pharmacogenetics, which is more focused on hereditary factors.</p>
    <br>
    <p>Question 2:</p>
    <p>What is a single nucleotide polymorphism (SNP)?</p>
    <p>A) A large deletion in a DNA sequence<br>
      B) A variation in a single base pair in a DNA sequence<br>
      C) A mutation that completely changes the function of a gene<br>
      D) A process by which proteins are synthesized from DNA</p>
    <p>Answer: B) A variation in a single base pair in a DNA sequence</p>
    <p>Explanation: A SNP is a small genetic variation in which a single nucleotide base (A, T, C, or G) in the DNA sequence is altered. These variations can impact how individuals respond to medications.</p>
    <br>
    <p>Question 3:</p>
    <p>Which factor is not a contributor to variations in medication response as discussed in pharmacogenomics?</p>
    <p>A) Genetic differences in metabolizing enzymes<br>
      B) Protein receptor variations<br>
      C) Age, gender, and comorbid conditions<br>
      D) The presence of viral infections</p>
    <p>Answer: D) The presence of viral infections</p>
    <p>Explanation: The text highlights genetic factors (such as differences in metabolizing enzymes and protein receptors) and non-genetic factors (like age, gender, and comorbid conditions) as key contributors to medication response variability. Viral infections, although they can impact health, are not discussed as a primary focus of pharmacogenomics.</p>
  </div>

  <div style="text-align: center;">
    <button onclick="generateQuiz()">Generate Quiz & Answer Key</button>
  </div>

  <div id="quizOutput" class="section"></div>
  <div id="answerKeyOutput" class="section"></div>

  <script>
    /* Fisher–Yates shuffle */
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function splitChoice(str) {
      const m = str.trim().match(/^([A-Z])\)\s*(.*)$/);
      return m ? { letter: m[1], text: m[2] } : { letter: "", text: str.trim() };
    }

    /* Remove content from first "Answer:" onward */
    function extractQuizHTML(html) {
      const temp = document.createElement("div");
      temp.innerHTML = html;
      let reached = false;
      Array.from(temp.childNodes).forEach(node => {
        if (reached) { node.remove(); return; }
        const t = node.textContent || "";
        if (/Answer/i.test(t)) {
          if (node.nodeType === Node.TEXT_NODE) {
            node.textContent = t.split(/Answer/i)[0];
          } else {
            node.innerHTML = node.innerHTML.split(/Answer/i)[0];
          }
          reached = true;
        }
      });
      return temp.innerHTML;
    }

    /* Strip trailing <br> tags so we don't duplicate line breaks */
    function stripTrailingBr(html) {
      return html.replace(/\s*(<br\s*\/?>\s*)+$/i, "");
    }

    /* Replace leading letter while preserving rest;
       also strip any leftover <br> and <p>  */
    function applyNewLetter(htmlLine, newLetter) {
        // 1. kill dangling <br> and <p> tags
        const cleaned = htmlLine
            .replace(/<br>/i, "")         // remove <br> tags
            .replace(/<\/?p>/gi, "");          // remove <p> tags
        console.log(cleaned);
        // 2. replace the answer label
        return cleaned.replace(/(^[^A-Z]*)([A-Z])\)/, `$1${newLetter})`);
    }

    function generateQuiz() {
      const inputHTML = document.getElementById("inputArea").innerHTML;
      const qRegex = /Question\s*(\d+)\s*:?([\s\S]*?)(?=Question\s*\d+\s*:?|$)/gi;

      let quizHtml = "<h2>Quiz</h2>";
      let answerKeyHtml = "<h2>Answer Key</h2>";
      let match, found = false;

      while ((match = qRegex.exec(inputHTML)) !== null) {
        found = true;
        const qNum = match[1];
        const blockHTML = match[2].trim();

        /* -------- Extract correct answer & explanation -------- */
        const tmpAll = document.createElement("div");
        tmpAll.innerHTML = blockHTML;
        const fullText = tmpAll.textContent || tmpAll.innerText;
        const ansParts = fullText.split(/Answer:\s*/i);
        let answerText = "[No Answer Provided]", explanationText = "";
        if (ansParts.length > 1) {
          const expSplit = ansParts[1].split(/Explanation:\s*/i);
          answerText = expSplit[0].trim();
          if (expSplit.length > 1) explanationText = expSplit[1].trim();
        }
        const correctText = splitChoice(answerText).text;

        /* -------- Build quiz section -------- */
        let quizHTML = extractQuizHTML(blockHTML);
        const tmpQuiz = document.createElement("div");
        tmpQuiz.innerHTML = quizHTML;

        const rawChoices = [];
        tmpQuiz.childNodes.forEach(node => {
          const htmlLine = node.outerHTML || node.innerHTML || node.textContent || "";
          htmlLine.split(/<br\s*\/?>|\n|\r/).forEach(chunk => {
            const plain = chunk.replace(/<[^>]*>/g, "").trim();
            if (/^[A-Z]\)/.test(plain)) {
              rawChoices.push({ originalHtml: stripTrailingBr(chunk.trim()), text: splitChoice(plain).text });
            }
          });
        });

        const shuffled = shuffleArray([...rawChoices]);
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        let newCorrectLetter = "";
        const rebuiltLines = shuffled.map((choice, idx) => {
          const letter = letters[idx];
          if (choice.text === correctText) newCorrectLetter = letter;
          return applyNewLetter(choice.originalHtml, letter);
        });

        /* Replace old choice nodes */
        Array.from(tmpQuiz.childNodes).forEach(n => {
          if (/^[A-Z]\)/.test((n.textContent||"").trim())) n.remove();
        });
        const newP = document.createElement("p");

        console.log(rebuiltLines)
        newP.innerHTML = rebuiltLines.join("<br>");
        tmpQuiz.appendChild(newP);

        quizHtml += `<div class="question-block">\n<p><strong>Question ${qNum}:</strong></p>\n<div class="question-content">${tmpQuiz.innerHTML}</div>\n</div>`;

        /* -------- Answer key -------- */
        answerKeyHtml += `<div class="question-block">\n<p><strong>Question ${qNum}:</strong></p>\n<p><strong>Answer:</strong> ${newCorrectLetter}) ${correctText}</p>${explanationText ? `<p><strong>Explanation:</strong> ${explanationText}</p>` : ""}\n</div>`;
      }

      if (!found) {
        quizHtml += "<p>No questions found.</p>";
        answerKeyHtml += "<p>No questions found.</p>";
      }

      document.getElementById("quizOutput").innerHTML = quizHtml;
      document.getElementById("answerKeyOutput").innerHTML = answerKeyHtml;
    }
  </script>
</body>
</html>
