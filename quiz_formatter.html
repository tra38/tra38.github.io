<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quiz & Answer Key Generator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
    h1, h2 { text-align: center; }
    #inputArea { width: 100%; min-height: 250px; border: 1px solid #ccc; padding: 10px; overflow: auto; margin-bottom: 20px; }
    .section { border: 1px solid #888; padding: 15px; margin-bottom: 30px; }
    .question-block { margin-bottom: 20px; }
    .question-block p { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>Quiz & Answer Key Generator</h1>
  <p>
    Paste your formatted questions below. (Any HTML formatting – such as <strong>bold text</strong> – will be preserved.)
  </p>
  <p>Generated by o3-mini-high and o3.</p>
  <div id="inputArea" contenteditable="true">
    <!-- Example questions -->
    <p>Question 1:</p>
    <p>Which of the following best describes pharmacogenomics?</p>
    <p>A) The study of the physical and chemical properties of drugs<br>
      B) The study of hereditary factors on individual responses to medications<br>
      C) The study of genetic factors influencing drug effectiveness, toxicity, and metabolism<br>
      D) The study of drug interactions and their effects on the body</p>
    <p>Answer: C) The study of genetic factors influencing drug effectiveness, toxicity, and metabolism</p>
    <p>Explanation: Pharmacogenomics focuses on how genetic variations affect an individual's response to medications, influencing drug metabolism, effectiveness, and toxicity. This differs from pharmacogenetics, which is more focused on hereditary factors.</p>
    <br>
    <p>Question 2:</p>
    <p>What is a single nucleotide polymorphism (SNP)?</p>
    <p>A) A large deletion in a DNA sequence<br>
      B) A variation in a single base pair in a DNA sequence<br>
      C) A mutation that completely changes the function of a gene<br>
      D) A process by which proteins are synthesized from DNA</p>
    <p>Answer: B) A variation in a single base pair in a DNA sequence</p>
    <p>Explanation: A SNP is a small genetic variation in which a single nucleotide base (A, T, C, or G) in the DNA sequence is altered. These variations can impact how individuals respond to medications.</p>
    <br>
    <p>Question 3:</p>
    <p>Which factor is not a contributor to variations in medication response as discussed in pharmacogenomics?</p>
    <p>A) Genetic differences in metabolizing enzymes<br>
      B) Protein receptor variations<br>
      C) Age, gender, and comorbid conditions<br>
      D) The presence of viral infections</p>
    <p>Answer: D) The presence of viral infections</p>
    <p>Explanation: The text highlights genetic factors (such as differences in metabolizing enzymes and protein receptors) and non-genetic factors (like age, gender, and comorbid conditions) as key contributors to medication response variability. Viral infections, although they can impact health, are not discussed as a primary focus of pharmacogenomics.</p>
  </div>

  <div style="text-align: center;">
    <button onclick="generateQuiz()">Generate Quiz & Answer Key</button>
  </div>

  <div id="quizOutput" class="section"></div>
  <div id="answerKeyOutput" class="section"></div>

  <script>
    /* Fisher–Yates shuffle */
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function splitChoice(str) {
      const m = str.trim().match(/^([A-Z])\)\s*(.*)$/);
      return m ? { letter: m[1], text: m[2] } : { letter: "", text: str.trim() };
    }

    /* Remove content from first "Answer:" onward */
    function extractQuizHTML(html) {
      const temp = document.createElement("div");
      temp.innerHTML = html;
      let reached = false;
      Array.from(temp.childNodes).forEach(node => {
        if (reached) { node.remove(); return; }
        const t = node.textContent || "";
        if (/Answer/i.test(t)) {
          if (node.nodeType === Node.TEXT_NODE) {
            node.textContent = t.split(/Answer/i)[0];
          } else {
            node.innerHTML = node.innerHTML.split(/Answer/i)[0];
          }
          reached = true;
        }
      });
      return temp.innerHTML;
    }

    /* Strip trailing <br> tags so we don't duplicate line breaks */
    function stripTrailingBr(html) {
      return html.replace(/\s*(<br\s*\/?>\s*)+$/i, "");
    }

    /* Replace leading letter while preserving rest;
       also strip any leftover <br> and <p>  */
    function applyNewLetter(htmlLine, newLetter) {
        // 1. kill dangling <br> and <p> tags
        const cleaned = htmlLine
            .replace(/<br\s*\/?>/gi, "")      // remove *all* <br> tags
            .replace(/<\/?p>/gi, "")          // strip any <p> that slipped through
            .trim();
        // 2. replace the answer label
        return cleaned.replace(/(^[^A-Z]*)([A-Z])\)/, `$1${newLetter})`);
    }

    function generateQuiz() {
      const inputHTML = document.getElementById("inputArea").innerHTML;

      /* Detects:
        <p><strong>Question 1</strong>:<br> …          (all on one line)
        <p><strong>Question 1:</strong></p>            (header paragraph)
        <p>Question 1:<br> …                           (no bold at all)

        ── Capture 1 = question number
        ── Capture 2 = everything up to the next “Question …” or EOF
      */
      const qRegex = new RegExp(
        [
          '(?:<p[^>]*>)?',                               // optional opening <p>
          '\\s*(?:<strong>|<b>)?\\s*',                   // optional <strong> / <b>
          'Question\\s*(\\d+)\\s*',                      // the word + digits      → (1)
          '(?:<\\/strong>|<\\/b>)?',                     // optional closing tag
          '\\s*:?\\s*',                                  // optional colon + space
          '([\\s\\S]*?)',                                // question block         → (2)
          '(?=',                                         // look-ahead: stop at…
            '(?:<p[^>]*>\\s*(?:<strong>|<b>)?\\s*Question\\s*\\d+)', // …next header
            '|$',                                       // …or end of file
          ')'
        ].join(''),
        'gi'                                             // g = global, i = ignore case
      );
      
      let quizHtml = "<h2>Quiz</h2>";
      let answerKeyHtml = "<h2>Answer Key</h2>";
      let match, found = false;

      while ((match = qRegex.exec(inputHTML)) !== null) {
        found = true;
        const qNum = match[1];
        const blockHTML = match[2].trim();

        /* -------- Extract correct answer & explanation -------- */
        const tmpAll = document.createElement("div");
        tmpAll.innerHTML = blockHTML;
        const fullText = tmpAll.textContent || tmpAll.innerText;
        const ansParts = fullText.split(/Answer:\s*/i);
        let answerText = "[No Answer Provided]", explanationText = "";
        if (ansParts.length > 1) {
          const expSplit = ansParts[1].split(/Explanation:\s*/i);
          answerText = expSplit[0].trim();
          if (expSplit.length > 1) explanationText = expSplit[1].trim();
        }
        const correctText = splitChoice(answerText).text;

        /* -------- Build quiz section -------- */
        let quizHTML = extractQuizHTML(blockHTML);

        const tmpQuiz = document.createElement("div");
        tmpQuiz.innerHTML = quizHTML;
                
        /* Remove any “Question n:” paragraph that might still be there */
        const firstP = tmpQuiz.querySelector("p");
        if (firstP && /^\s*Question\s*\d+\s*:?\s*$/.test(firstP.textContent)) {
          firstP.remove();
        }

        const rawChoices = [];
        tmpQuiz.childNodes.forEach(node => {
          const htmlLine = node.outerHTML || node.innerHTML || node.textContent || "";
          htmlLine.split(/<br\s*\/?>|\n|\r/)
            .map(chunk => chunk.trim())
            .filter(Boolean)          //  <-- keeps only non-empty chunks
            .forEach(chunk => {
            const plain = chunk.replace(/<[^>]*>/g, "").trim();
            if (/^[A-Z]\)/.test(plain)) {
              rawChoices.push({ originalHtml: stripTrailingBr(chunk.trim()), text: splitChoice(plain).text });
            }
          });
        });

        const shuffled = shuffleArray([...rawChoices]);
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        let newCorrectLetter = "";
        const rebuiltLines = shuffled.map((choice, idx) => {
          const letter = letters[idx];
          if (choice.text === correctText) newCorrectLetter = letter;
          return applyNewLetter(choice.originalHtml, letter);
        });

        /* --- after you have `rebuiltLines` and know newCorrectLetter --- */
        const questionOnlyHTML = tmpQuiz.innerHTML
          // split the paragraph into individual lines
          .split(/<br\s*\/?>/i)
          // keep everything that is *not* a multiple-choice line
          .filter(l => !/^[A-Z]\)/.test(l.replace(/<[^>]*>/g, "").trim()))
          .join("<br>")
          // collapse a run of <br><br><br> into a single <br>
          .replace(/(<br\s*\/?>\s*)+/g, "<br>")
          // strip a possible leading/trailing <br>
          .replace(/^\s*<br>|<br>\s*$/g, "")
          .trim();

        /* overwrite the paragraph instead of appending a new one */
        tmpQuiz.innerHTML = questionOnlyHTML + "<br>" + rebuiltLines.join("<br>");
        
        quizHtml += `<div class="question-block">\n<p><strong>Question ${qNum}:</strong></p>\n<div class="question-content">${tmpQuiz.innerHTML}</div>\n</div>`;

        /* -------- Answer key -------- */
        answerKeyHtml += `<div class="question-block">\n<p><strong>Question ${qNum}:</strong></p>\n<p><strong>Answer:</strong> ${newCorrectLetter}) ${correctText}</p>${explanationText ? `<p><strong>Explanation:</strong> ${explanationText}</p>` : ""}\n</div>`;
      }

      if (!found) {
        quizHtml += "<p>No questions found.</p>";
        answerKeyHtml += "<p>No questions found.</p>";
      }

      document.getElementById("quizOutput").innerHTML = quizHtml;
      document.getElementById("answerKeyOutput").innerHTML = answerKeyHtml;
    }
  </script>
</body>
</html>
